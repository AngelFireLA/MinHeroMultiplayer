{"version":3,"file":"signature.js","names":["_util","require","_checksum","dataViewSlice","dv","offset","size","DataView","buffer","byteOffset","dataViewCopy","start","slice","dataViewConcat","dvs","total","reduce","a","b","byteLength","concat","ArrayBuffer","Uint8Array","set","offsetNtHeader","view","getUint32","offsetOptionalHeader","offsetSecurity","optionalHeader","magic","getUint16","bits","Error","toString","rvaCountOffset","rvaCount","signatureGet","data","dataAsDataViewReadonly","security","signatureSet","signature","updateChecksum","preserveNullChecksum","sig","end","result","setUint32","checksumUpdate"],"sources":["../src/signature.ts"],"sourcesContent":["import {ArrayBuffers, IArrayBufferView} from './types.ts';\nimport {dataAsDataViewReadonly} from './util.ts';\nimport {checksumUpdate} from './checksum.ts';\n\n/**\n * Get data view slice, using same underlying buffer.\n *\n * @param dv Data view.\n * @param offset View offset.\n * @param size View size.\n * @returns Data view.\n */\nfunction dataViewSlice(dv: Readonly<DataView>, offset: number, size: number) {\n\treturn new DataView(\n\t\tdv.buffer,\n\t\tdv.byteOffset + offset,\n\t\tsize\n\t) as Readonly<DataView>;\n}\n\n/**\n * Copy data view slice, copying the underlying buffer.\n *\n * @param dv Data view.\n * @param offset Copy offset.\n * @param size Copy size.\n * @returns Data view.\n */\nfunction dataViewCopy(dv: Readonly<DataView>, offset: number, size: number) {\n\tconst start = dv.byteOffset + offset;\n\treturn dv.buffer.slice(start, start + size);\n}\n\n/**\n * Concatenate data view list.\n *\n * @param dvs Data views.\n * @param total Total size, optional, otherwise computed from the list.\n * @returns Array buffer.\n */\nfunction dataViewConcat(\n\tdvs: Readonly<DataView>[],\n\ttotal: number | null = null\n) {\n\t// Calculate size if necessary.\n\tconst size =\n\t\ttotal === null ? dvs.reduce((a, b) => a + b.byteLength, 0) : total;\n\n\t// Write all the data to one array buffer.\n\tconst concat = new ArrayBuffer(size);\n\tlet offset = 0;\n\tfor (const {buffer, byteOffset, byteLength} of dvs) {\n\t\tnew Uint8Array(concat, offset, byteLength).set(\n\t\t\tnew Uint8Array(buffer, byteOffset, byteLength),\n\t\t\t0\n\t\t);\n\t\toffset += byteLength;\n\t}\n\treturn concat;\n}\n\n/**\n * Get NT header offset.\n *\n * @param view Data view.\n * @returns The offset.\n */\nfunction offsetNtHeader(view: Readonly<DataView>) {\n\treturn view.getUint32(60, true);\n}\n\n/**\n * Get NT header offset.\n *\n * @param view Data view.\n * @returns The offset.\n */\nfunction offsetOptionalHeader(view: Readonly<DataView>) {\n\treturn offsetNtHeader(view) + 24;\n}\n\n/**\n * Get the secruity offset.\n *\n * @param view Data view.\n * @returns The offset.\n */\nfunction offsetSecurity(view: Readonly<DataView>) {\n\tconst optionalHeader = offsetOptionalHeader(view);\n\tconst magic = view.getUint16(optionalHeader, true);\n\tlet bits = 0;\n\tswitch (magic) {\n\t\tcase 0x10b: {\n\t\t\tbits = 32;\n\t\t\tbreak;\n\t\t}\n\t\tcase 0x20b: {\n\t\t\tbits = 64;\n\t\t\tbreak;\n\t\t}\n\t\tdefault: {\n\t\t\tthrow new Error(\n\t\t\t\t`Unknown optional header magic: ${magic.toString(16)}`\n\t\t\t);\n\t\t}\n\t}\n\n\tconst rvaCountOffset = optionalHeader + (bits === 64 ? 108 : 92);\n\tconst rvaCount = view.getUint32(rvaCountOffset, true);\n\tif (rvaCount < 5) {\n\t\tthrow new Error('No PE security field');\n\t}\n\treturn rvaCountOffset + 4 + 4 * 8;\n}\n\n/**\n * PE signature getter.\n *\n * @param data PE data.\n * @returns Signature data, or null.\n */\nexport function signatureGet(data: Readonly<ArrayBuffers | IArrayBufferView>) {\n\tconst view = dataAsDataViewReadonly(data);\n\tconst security = offsetSecurity(view);\n\n\tconst offset = view.getUint32(security, true);\n\tif (!offset) {\n\t\treturn null;\n\t}\n\n\tconst size = view.getUint32(security + 4, true);\n\treturn dataViewCopy(view, offset, size);\n}\n\n/**\n * PE signature setter, removes signature if null.\n *\n * @param data PE data.\n * @param signature Signature data or null to remove.\n * @param updateChecksum Update checksum.\n * @param preserveNullChecksum Preserve a null checksum.\n * @returns Updated PE.\n */\nexport function signatureSet(\n\tdata: Readonly<ArrayBuffers | IArrayBufferView>,\n\tsignature: Readonly<ArrayBuffers | IArrayBufferView> | null,\n\tupdateChecksum = true,\n\tpreserveNullChecksum = false\n) {\n\tconst view = dataAsDataViewReadonly(data);\n\tconst sig = signature ? dataAsDataViewReadonly(signature) : null;\n\n\tconst security = offsetSecurity(view);\n\n\tconst offset = view.getUint32(security, true);\n\tconst size = view.getUint32(security + 4, true);\n\tif (offset && offset + size !== data.byteLength) {\n\t\tthrow new Error('Expected signature to be at end of file');\n\t}\n\n\tconst end = offset || view.byteLength;\n\tconst result = new DataView(\n\t\tsig\n\t\t\t? dataViewConcat(\n\t\t\t\t\t[dataViewSlice(view, 0, end), sig],\n\t\t\t\t\tend + sig.byteLength\n\t\t\t\t)\n\t\t\t: dataViewCopy(view, 0, end)\n\t);\n\n\tresult.setUint32(security, sig ? end : 0, true);\n\tresult.setUint32(security + 4, sig ? sig.byteLength : 0, true);\n\n\tif (updateChecksum) {\n\t\tchecksumUpdate(result, preserveNullChecksum);\n\t}\n\treturn result.buffer;\n}\n"],"mappings":"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","ignoreList":[]}