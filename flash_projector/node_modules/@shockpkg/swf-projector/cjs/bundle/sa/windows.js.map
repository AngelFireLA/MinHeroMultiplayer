{"version":3,"file":"windows.js","names":["_promises","require","_nodePath","_util","_windows","_windows2","_sa","BundleSaWindows","BundleSa","constructor","path","flat","projector","_createProjector","extension","_getProjectorPathNested","directory","trimExtension","Error","pathJoin","basename","ProjectorSaWindows","_getProjectorPath","_writeLauncher","d","Uint8Array","v","DataView","buffer","byteOffset","byteLength","f","open","r","read","bytesRead","getUint32","close","machine","getUint16","res","readFile","launcher","windowsLauncher","mkdir","dirname","recursive","writeFile","exports"],"sources":["../../../src/bundle/sa/windows.ts"],"sourcesContent":["import {mkdir, open, readFile, writeFile} from 'node:fs/promises';\nimport {join as pathJoin, basename, dirname} from 'node:path';\n\nimport {trimExtension} from '../../util.ts';\nimport {windowsLauncher} from '../../util/windows.ts';\nimport {ProjectorSaWindows} from '../../projector/sa/windows.ts';\nimport {BundleSa} from '../sa.ts';\n\n/**\n * BundleSaWindows object.\n */\nexport class BundleSaWindows extends BundleSa {\n\t/**\n\t * ProjectorSaWindows instance.\n\t */\n\tpublic readonly projector: ProjectorSaWindows;\n\n\t/**\n\t * BundleSaWindows constructor.\n\t *\n\t * @param path Output path for the main application.\n\t * @param flat Flat bundle.\n\t */\n\tconstructor(path: string, flat = false) {\n\t\tsuper(path, flat);\n\n\t\tthis.projector = this._createProjector();\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic get extension() {\n\t\treturn '.exe';\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tprotected _getProjectorPathNested(): string {\n\t\tconst {path, extension} = this;\n\t\tconst directory = trimExtension(path, extension, true);\n\t\tif (directory === path) {\n\t\t\tthrow new Error(`Output path must end with: ${extension}`);\n\t\t}\n\t\treturn pathJoin(directory, basename(path));\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tprotected _createProjector() {\n\t\treturn new ProjectorSaWindows(this._getProjectorPath());\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tprotected async _writeLauncher() {\n\t\tconst {path, projector} = this;\n\n\t\tconst d = new Uint8Array(4);\n\t\tconst v = new DataView(d.buffer, d.byteOffset, d.byteLength);\n\t\tconst f = await open(projector.path, 'r');\n\t\ttry {\n\t\t\tlet r = await f.read(d, 0, 4, 60);\n\t\t\tif (r.bytesRead < 4) {\n\t\t\t\tthrow new Error('Unknown format');\n\t\t\t}\n\t\t\tr = await f.read(d, 0, 2, v.getUint32(0, true) + 4);\n\t\t\tif (r.bytesRead < 2) {\n\t\t\t\tthrow new Error('Unknown format');\n\t\t\t}\n\t\t} finally {\n\t\t\tawait f.close();\n\t\t}\n\n\t\tconst machine = v.getUint16(0, true);\n\t\t// eslint-disable-next-line jsdoc/require-jsdoc\n\t\tconst res = async () => readFile(projector.path);\n\t\tlet launcher = null;\n\t\tswitch (machine) {\n\t\t\tcase 0x14c: {\n\t\t\t\tlauncher = await windowsLauncher('i686', res);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 0x8664: {\n\t\t\t\tlauncher = await windowsLauncher('x86_64', res);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\tthrow new Error(`Unknown machine type: ${machine}`);\n\t\t\t}\n\t\t}\n\n\t\tawait mkdir(dirname(path), {recursive: true});\n\t\tawait writeFile(path, launcher);\n\t}\n}\n"],"mappings":"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","ignoreList":[]}