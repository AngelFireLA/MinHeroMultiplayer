{"version":3,"file":"html.js","names":["_nodePath","require","_promises","_bundle","_html","_util","BundleHtml","Bundle","constructor","path","flat","projector","_createProjector","extension","a","basename","split","ext","length","pop","Error","subdir","trimExtension","index","getLauncher","lang","title","url","map","encodeURIComponent","join","hAttr","htmlEncode","s","replace","repeat","_close","_writeLauncher","_getProjectorPathNested","pathJoin","dirname","ProjectorHtml","_getProjectorPath","mkdir","recursive","writeFile","exports"],"sources":["../../src/bundle/html.ts"],"sourcesContent":["import {basename, dirname, join as pathJoin} from 'node:path';\nimport {mkdir, writeFile} from 'node:fs/promises';\n\nimport {Bundle} from '../bundle.ts';\nimport {ProjectorHtml} from '../projector/html.ts';\nimport {htmlEncode, trimExtension} from '../util.ts';\n\n/**\n * BundleHtml object.\n */\nexport class BundleHtml extends Bundle {\n\t/**\n\t * ProjectorHtml instance.\n\t */\n\tpublic readonly projector: ProjectorHtml;\n\n\t/**\n\t * BundleHtml constructor.\n\t *\n\t * @param path Output path.\n\t * @param flat Flat bundle.\n\t */\n\tconstructor(path: string, flat = false) {\n\t\tsuper(path, flat);\n\n\t\tthis.projector = this._createProjector();\n\t}\n\n\t/**\n\t * Main application file extension.\n\t *\n\t * @returns File extension.\n\t */\n\tpublic get extension() {\n\t\tconst a = basename(this.path).split('.');\n\t\tconst ext = a.length > 1 ? a.pop() : '';\n\t\tif (!ext) {\n\t\t\tthrow new Error('Failed to extract extension');\n\t\t}\n\t\treturn `.${ext}`;\n\t}\n\n\t/**\n\t * Get the nested subdirectory.\n\t *\n\t * @returns Directory name.\n\t */\n\tpublic get subdir() {\n\t\treturn trimExtension(basename(this.path), this.extension);\n\t}\n\n\t/**\n\t * Get the nested index.\n\t *\n\t * @returns File name.\n\t */\n\tpublic get index() {\n\t\treturn `index${this.extension}`;\n\t}\n\n\t/**\n\t * Get launcher HTML code.\n\t *\n\t * @returns HTML code.\n\t */\n\tpublic getLauncher() {\n\t\tconst {projector, subdir, index} = this;\n\t\tconst {lang, title} = projector;\n\t\tconst path = `${subdir}/${index}`;\n\t\tconst url = path.split(/[/\\\\]/).map(encodeURIComponent).join('/');\n\t\tconst hAttr = lang === null ? '' : ` lang=\"${htmlEncode(lang, true)}\"`;\n\n\t\treturn [\n\t\t\t'<!DOCTYPE html>',\n\t\t\t`<html${hAttr}>`,\n\t\t\t' <head>',\n\t\t\t'  <meta charset=\"UTF-8\">',\n\t\t\t'  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=Edge\">',\n\t\t\t`  <meta http-equiv=\"refresh\" content=\"0; url=${htmlEncode(\n\t\t\t\turl,\n\t\t\t\ttrue\n\t\t\t)}\">`,\n\t\t\t...(title === null\n\t\t\t\t? []\n\t\t\t\t: [`  <title>${htmlEncode(title)}</title>`]),\n\t\t\t' </head>',\n\t\t\t' <body></body>',\n\t\t\t'</html>',\n\t\t\t''\n\t\t]\n\t\t\t.map(s => s.replace(/^\\s+/, s => '\\t'.repeat(s.length)))\n\t\t\t.join('\\n');\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tprotected async _close(): Promise<void> {\n\t\tif (!this.flat) {\n\t\t\tawait this._writeLauncher();\n\t\t}\n\t\tawait super._close();\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tprotected _getProjectorPathNested(): string {\n\t\treturn pathJoin(dirname(this.path), this.subdir, this.index);\n\t}\n\n\t/**\n\t * Create projector instance for the bundle.\n\t *\n\t * @returns Projector instance.\n\t */\n\tprotected _createProjector() {\n\t\treturn new ProjectorHtml(this._getProjectorPath());\n\t}\n\n\t/**\n\t * Write the launcher file.\n\t */\n\tprotected async _writeLauncher() {\n\t\tconst {path} = this;\n\t\tawait mkdir(dirname(path), {recursive: true});\n\t\tawait writeFile(path, this.getLauncher());\n\t}\n}\n"],"mappings":"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","ignoreList":[]}