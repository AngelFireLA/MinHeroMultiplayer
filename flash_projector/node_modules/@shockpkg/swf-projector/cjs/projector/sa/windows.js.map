{"version":3,"file":"windows.js","names":["_promises","require","_nodePath","_archiveFiles","_windows","_sa","_data","ProjectorSaWindows","ProjectorSa","iconData","iconFile","versionStrings","removeCodeSignature","patchWindowTitle","patchOutOfDateDisable","constructor","path","extension","getIconData","d","readFile","Uint8Array","buffer","byteOffset","byteLength","_writePlayer","player","extLower","toLowerCase","archive","isPlayer","st","endsWith","stat","isFile","name","basename","ArchiveDir","dirname","subpaths","isDirectory","createArchiveByFileExtensionOrThrow","nobrowse","patches","_getPatches","extract","entry","dest","type","PathType","FILE","data","patch","match","volumePath","read","Error","modify","mkdir","recursive","writeFile","setAttributes","ignoreTimes","playerPath","Promise","all","map","p","after","_getPatchBinary","_getPatchMovie","filter","Boolean","file","windowsProjectorPatch","movieData","getMovieData","concat","_encodeMovieData","exports"],"sources":["../../../src/projector/sa/windows.ts"],"sourcesContent":["import {stat, readFile, writeFile, mkdir} from 'node:fs/promises';\nimport {basename, dirname} from 'node:path';\n\nimport {\n\tArchiveDir,\n\tEntry,\n\tPathType,\n\tcreateArchiveByFileExtensionOrThrow\n} from '@shockpkg/archive-files';\n\nimport {windowsProjectorPatch} from '../../util/windows.ts';\nimport {IFilePatch, ProjectorSa} from '../sa.ts';\nimport {concat} from '../../util/internal/data.ts';\n\n/**\n * ProjectorSaWindows object.\n */\nexport class ProjectorSaWindows extends ProjectorSa {\n\t/**\n\t * Icon data.\n\t */\n\tpublic iconData:\n\t\t| Readonly<Uint8Array>\n\t\t| (() => Readonly<Uint8Array>)\n\t\t| (() => Promise<Readonly<Uint8Array>>)\n\t\t| null = null;\n\n\t/**\n\t * Icon file.\n\t */\n\tpublic iconFile: string | null = null;\n\n\t/**\n\t * Version strings.\n\t */\n\tpublic versionStrings: Readonly<{[key: string]: string}> | null = null;\n\n\t/**\n\t * Remove the code signature.\n\t */\n\tpublic removeCodeSignature = false;\n\n\t/**\n\t * Attempt to patch the window title with a custom title.\n\t * Set to string to automatically patch the binary if possible.\n\t */\n\tpublic patchWindowTitle: string | null = null;\n\n\t/**\n\t * Disable the out-of-date check introduced in version 30.\n\t * Important since version 35 where there are 90 and 180 day defaults.\n\t */\n\tpublic patchOutOfDateDisable = false;\n\n\t/**\n\t * ProjectorSaWindows constructor.\n\t *\n\t * @param path Output path.\n\t */\n\tconstructor(path: string) {\n\t\tsuper(path);\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic get extension() {\n\t\treturn '.exe';\n\t}\n\n\t/**\n\t * Get icon data if any specified, from data or file.\n\t *\n\t * @returns Icon data or null.\n\t */\n\tpublic async getIconData() {\n\t\tconst {iconData, iconFile} = this;\n\t\tif (iconData) {\n\t\t\treturn typeof iconData === 'function' ? iconData() : iconData;\n\t\t}\n\t\tif (iconFile) {\n\t\t\tconst d = await readFile(iconFile);\n\t\t\treturn new Uint8Array(d.buffer, d.byteOffset, d.byteLength);\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tprotected async _writePlayer(player: string) {\n\t\tconst {path, extension} = this;\n\t\tconst extLower = extension.toLowerCase();\n\n\t\tlet archive;\n\t\tlet isPlayer: (path: string) => boolean;\n\t\tlet st = player.toLowerCase().endsWith(extLower)\n\t\t\t? await stat(player)\n\t\t\t: null;\n\t\tif (st?.isFile()) {\n\t\t\tconst name = basename(player);\n\t\t\tarchive = new ArchiveDir(dirname(player));\n\t\t\tarchive.subpaths = [name];\n\t\t\t// eslint-disable-next-line jsdoc/require-jsdoc\n\t\t\tisPlayer = (path: string) => path === name;\n\t\t} else {\n\t\t\tst ??= await stat(player);\n\t\t\tarchive = st.isDirectory()\n\t\t\t\t? new ArchiveDir(player)\n\t\t\t\t: createArchiveByFileExtensionOrThrow(player, {\n\t\t\t\t\t\tnobrowse: this.nobrowse\n\t\t\t\t\t});\n\t\t\t// eslint-disable-next-line jsdoc/require-jsdoc\n\t\t\tisPlayer = (path: string) => path.toLowerCase().endsWith(extLower);\n\t\t}\n\n\t\tconst patches = await this._getPatches();\n\n\t\t/**\n\t\t * Extract entry, and also apply patches if any.\n\t\t *\n\t\t * @param entry Archive entry.\n\t\t * @param dest Output path.\n\t\t */\n\t\tconst extract = async (entry: Entry, dest: string) => {\n\t\t\tif (entry.type === PathType.FILE) {\n\t\t\t\tlet data: Uint8Array | null = null;\n\t\t\t\tfor (const patch of patches) {\n\t\t\t\t\t// eslint-disable-next-line unicorn/prefer-regexp-test\n\t\t\t\t\tif (patch.match(entry.volumePath)) {\n\t\t\t\t\t\tif (!data) {\n\t\t\t\t\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\t\t\t\t\tconst d = await entry.read();\n\t\t\t\t\t\t\tif (!d) {\n\t\t\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t\t\t`Failed to read: ${entry.volumePath}`\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tdata = new Uint8Array(\n\t\t\t\t\t\t\t\td.buffer,\n\t\t\t\t\t\t\t\td.byteOffset,\n\t\t\t\t\t\t\t\td.byteLength\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\t\t\t\tdata = await patch.modify(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (data) {\n\t\t\t\t\tawait mkdir(dirname(dest), {recursive: true});\n\t\t\t\t\tawait writeFile(dest, data);\n\t\t\t\t\tawait entry.setAttributes(dest, null, {\n\t\t\t\t\t\tignoreTimes: true\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tawait entry.extract(dest);\n\t\t};\n\n\t\tlet playerPath = '';\n\t\tawait archive.read(async entry => {\n\t\t\tconst {volumePath, type} = entry;\n\n\t\t\t// Only looking for regular files, no resource forks.\n\t\t\tif (type !== PathType.FILE) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\t// Ignore files that are not the player file.\n\t\t\tif (!isPlayer(volumePath)) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (playerPath) {\n\t\t\t\tthrow new Error(`Found multiple players in: ${player}`);\n\t\t\t}\n\t\t\tplayerPath = volumePath;\n\n\t\t\tawait extract(entry, path);\n\t\t\treturn true;\n\t\t});\n\n\t\tif (!playerPath) {\n\t\t\tthrow new Error(`Failed to locate player in: ${player}`);\n\t\t}\n\n\t\tawait Promise.all(patches.map(async p => p.after()));\n\t}\n\n\t/**\n\t * Get patches to apply.\n\t *\n\t * @returns Patches list.\n\t */\n\tprotected async _getPatches() {\n\t\treturn (\n\t\t\tawait Promise.all([this._getPatchBinary(), this._getPatchMovie()])\n\t\t).filter(Boolean) as IFilePatch[];\n\t}\n\n\t/**\n\t * Get patch for binary.\n\t *\n\t * @returns Patch spec.\n\t */\n\tprotected async _getPatchBinary() {\n\t\tconst {\n\t\t\tversionStrings,\n\t\t\tremoveCodeSignature,\n\t\t\tpatchWindowTitle,\n\t\t\tpatchOutOfDateDisable\n\t\t} = this;\n\t\tconst iconData = await this.getIconData();\n\t\tif (\n\t\t\t!(\n\t\t\t\ticonData ||\n\t\t\t\tversionStrings ||\n\t\t\t\tremoveCodeSignature ||\n\t\t\t\tpatchWindowTitle !== null ||\n\t\t\t\tpatchOutOfDateDisable\n\t\t\t)\n\t\t) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst patch: IFilePatch = {\n\t\t\t/**\n\t\t\t * @inheritdoc\n\t\t\t */\n\t\t\tmatch: (file: string) => true,\n\n\t\t\t/**\n\t\t\t * @inheritdoc\n\t\t\t */\n\t\t\tmodify: (data: Uint8Array) =>\n\t\t\t\twindowsProjectorPatch(data, {\n\t\t\t\t\ticonData,\n\t\t\t\t\tversionStrings,\n\t\t\t\t\tremoveCodeSignature,\n\t\t\t\t\tpatchWindowTitle,\n\t\t\t\t\tpatchOutOfDateDisable\n\t\t\t\t}),\n\n\t\t\t/**\n\t\t\t * @inheritdoc\n\t\t\t */\n\t\t\tafter: () => {}\n\t\t};\n\t\treturn patch;\n\t}\n\n\t/**\n\t * Get patch for movie.\n\t *\n\t * @returns Patch spec.\n\t */\n\tprotected async _getPatchMovie() {\n\t\tconst movieData = await this.getMovieData();\n\t\tif (!movieData) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst patch: IFilePatch = {\n\t\t\t/**\n\t\t\t * @inheritdoc\n\t\t\t */\n\t\t\tmatch: (file: string) => true,\n\n\t\t\t/**\n\t\t\t * @inheritdoc\n\t\t\t */\n\t\t\tmodify: (data: Uint8Array) =>\n\t\t\t\tconcat([data, this._encodeMovieData(movieData, 'dms')]),\n\n\t\t\t/**\n\t\t\t * @inheritdoc\n\t\t\t */\n\t\t\tafter: () => {}\n\t\t};\n\t\treturn patch;\n\t}\n}\n"],"mappings":"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","ignoreList":[]}